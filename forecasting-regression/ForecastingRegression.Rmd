---
title: "Forecasting multivariate time series models (regression models)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r echo=FALSE, warning=FALSE}
# Importing libraries
suppressMessages(library(quantmod))
suppressMessages(library(forecast))
suppressMessages(library(tseries))
```

```{r echo=FALSE}
training_dataset_range <- '2019::2020'
test_dataset_range <- '2021::'
```

## Introduction

The goal of this phase is to produce the best `multivariate regression model` 
for forecasting the return on our stock of choice - Microsoft. For that we will
use family of Linear regression models to find the best performing model.


The dependent variable in our regression model will be daily returns of Microsoft.
The chosen explanatory (independent) variables are also stocks (potential competitors) and stock market stock indexes.

Potential regressors in our regression models are:

- Apple (AAPL)
- Google (GOOG)
- IBM (IBM)
- 3M (MMM)
- S&P500 (^GSPC)
- Nasdaq (^IXIC)


## Splitting the dataset ("in-sample and" "out-of-sample")

The dataset splitting for dependent variable (Microsoft daily returns) has been done in the previous phase.

The training data set will contain daily return data from 2019. and 2020. and the test data will only contain first six months of 2021.


```{r, echo=FALSE}
MSFT <- read.csv(file = "../data/MSFT.csv", row.names = 1, header = TRUE)
MSFT_xts <- xts(MSFT[, 1:5], order.by=as.POSIXct(MSFT$date))
MSFT_xts.retDaily <- periodReturn(MSFT_xts, period = "daily")

MSFT_daily_ret_original <- ts(as.numeric(MSFT_xts.retDaily))
MSFT_daily_ret_training <- ts(as.numeric(MSFT_xts.retDaily[training_dataset_range]), frequency = 252, start=c(2019, 1))
MSFT_daily_ret_test <- ts(as.numeric(MSFT_xts.retDaily[test_dataset_range]), frequency = 252, start=c(2021, 1))

```

In order to split the dataset for potential regressors, we first need to check the stationarity properties of these time series, which is described in the next section.


## Stationarity property of explanatory variables

In this section, we will check the stationarity property of each time series.
That means, it needs to be determined that the time series is constant in mean and variance are constant and not dependent on time.

We will look at couple of methods for checking stationarity:

- Autocorrelation Function (ACF) - Identifying if correlation at different time lags goes to 0
- Augmented Dickey–Fuller (ADF) t-statistic test for unit root
- Kwiatkowski-Phillips-Schmidt-Shin (KPSS) for level or trend stationarity

### Apple (AAPL)

#### Stock prices


Let's see the graph of Apple closing prices for the past two and a half years:
```{r, echo=FALSE}
AAPL <- read.csv(file = "../data/AAPL.csv", row.names = 1, header = TRUE)
AAPL_xts <- xts(AAPL[, 1:5], order.by=as.POSIXct(AAPL$date))

chartSeries(AAPL_xts$AAPL.Close, theme = "white", up.col="blue", name = "AAPL - Closing prices")

# Converting to ts object
AAPL_prices <- ts(as.numeric(AAPL_xts$AAPL.Close))
```


It looks like this time series is not stationary, as we can see some shape of upward trend.

Now, we need to perform methods described in the introduction to conclude if the time series is stationary or not.
```{r, warning=FALSE, echo=FALSE}
# ACF
acf(AAPL_prices, lag.max = length(AAPL_prices), main="AAPL Closing Price Autocorrelation Function (ACF)")
```

From the plot above, we can conclude that almost all lags are exceeding the confidence interval of the ACF.


Another test we can conduct is the Augmented Dickey–Fuller (ADF) t-statistic test to find if the series has a unit root (a series with a trend line will have a unit root and result in a large p-value).
```{r, warning=FALSE, echo=FALSE}
# ADF test - closing price
adf.test(AAPL_prices)
```

The significance level (p-value) for ADF test is pretty high (almost 50%), so we cannot reject the null hypothesis.


Now, we can test if the time series is level or trend stationary using the Kwiatkowski-Phillips-Schmidt-Shin (KPSS) test. Here we will test the null hypothesis of trend stationarity (a low p-value will indicate a signal that is not trend stationary, has a unit root).
```{r, warning=FALSE, echo=FALSE}
# KPSS test - closing price
kpss.test(AAPL_prices, null="Trend")
```

The significance level (p-value) for KPSS test is really low (below 1%), so we are rejecting the null hypothesis, which means that this time series has a unit root.



#### Calculating daily returns

The stock prices time series is definitely not stationary, therefore we need to introduce some kind of modification.
One of the methods is to use differentiation of stock price i.e. calculate daily returns.


Let's see the graph of Apple daily returns for the past two and a half years:
```{r, echo=FALSE}
AAPL_xts.retDaily <- periodReturn(AAPL_xts, period = "daily")
chartSeries(AAPL_xts.retDaily, theme = "white", up.col="blue", name = "AAPL - Daily returns")

AAPL_retDaily <-ts(as.numeric(AAPL_xts.retDaily))
```

Well, now it looks different and more promising now. It looks this time series is stationary.

Let's prove it.

```{r, warning=FALSE, echo=FALSE}
# ACF
acf(AAPL_retDaily, lag.max = length(AAPL_retDaily), main="AAPL Daily return Autocorrelation Function (ACF)")
```

Now we can see that only few lags that exceed the confidence interval of the ACF (blue dashed line).

Performing ADF test:

```{r, warning=FALSE, echo=FALSE}
# ADF test - closing price
adf.test(AAPL_retDaily)
```

The significance level (p-value) is around 1%, so we can reject the null hypothesis (no presence of unit root).


And finally, KPSS test:
```{r, warning=FALSE, echo=FALSE}
# KPSS test - closing price
kpss.test(AAPL_retDaily, null="Trend")

```

The significance level (p-value) for KPSS test is more than 10%, so we are cannot reject the null hypothesis, which means that we cannot prove there is a unit root.


``` {r, echo=FALSE}
# Splitting the dataset
AAPL_daily_ret_training <- ts(as.numeric(AAPL_xts.retDaily[training_dataset_range]), frequency = 252, start=c(2019, 1))
AAPL_daily_ret_test <- ts(as.numeric(AAPL_xts.retDaily[test_dataset_range]), frequency = 252, start=c(2021, 1))
```

**== NOTE ==**

**We will repeat the same steps for all explanatory variables.**

### Google (GOOG)

#### Stock prices


Let's see the graph of Google closing prices for the past two and a half years:
```{r, echo=FALSE}
GOOG <- read.csv(file = "../data/GOOG.csv", row.names = 1, header = TRUE)
GOOG_xts <- xts(GOOG[, 1:5], order.by=as.POSIXct(GOOG$date))

chartSeries(GOOG_xts$GOOG.Close, theme = "white", up.col="blue", name = "GOOG - Closing prices")

# Converting to ts object
GOOG_prices <- ts(as.numeric(GOOG_xts$GOOG.Close))
```


It looks like this time series is not stationary, as we can see some shape of upward trend.

Now, we need to perform methods described in the introduction to conclude if the time series is stationary or not.
```{r, warning=FALSE, echo=FALSE}
# ACF
acf(GOOG_prices, lag.max = length(GOOG_prices), main="GOOG Closing Price Autocorrelation Function (ACF)")
```

From the plot above, we can conclude that almost all lags are exceeding the confidence interval of the ACF.


Performin ADF test:
```{r, warning=FALSE, echo=FALSE}
# ADF test - closing price
adf.test(GOOG_prices)
```

The significance level (p-value) for ADF test is really high (almost 100%), so we cannot reject the null hypothesis.


Performin KPSS test:
```{r, warning=FALSE, echo=FALSE}
# KPSS test - closing price
kpss.test(GOOG_prices, null="Trend")
```

The significance level (p-value) for KPSS test is really low (below 1%), so we are rejecting the null hypothesis, which means that this time series has a unit root.



#### Calculating daily returns

Let's see the graph of Google daily returns for the past two and a half years:
```{r, echo=FALSE}
GOOG_xts.retDaily <- periodReturn(GOOG_xts, period = "daily")
chartSeries(GOOG_xts.retDaily, theme = "white", up.col="blue", name = "GOOG - Daily returns")

GOOG_retDaily <-ts(as.numeric(GOOG_xts.retDaily))
```

Well, now it looks different and more promising now. It looks this time series is stationary.

Let's prove it.

```{r, warning=FALSE, echo=FALSE}
# ACF
acf(GOOG_retDaily, lag.max = length(GOOG_retDaily), main="GOOG Daily return Autocorrelation Function (ACF)")
```

Now we can see that only few lags that exceed the confidence interval of the ACF (blue dashed line).

Performing ADF test:

```{r, warning=FALSE, echo=FALSE}
# ADF test - closing price
adf.test(GOOG_retDaily)
```

The significance level (p-value) is around 1%, so we can reject the null hypothesis (no presence of unit root).


And finally, KPSS test:
```{r, warning=FALSE, echo=FALSE}
# KPSS test - closing price
kpss.test(GOOG_retDaily, null="Trend")

```

The significance level (p-value) for KPSS test is more than 10%, so we are cannot reject the null hypothesis, which means that we cannot prove there is a unit root.


``` {r, echo=FALSE}
# Splitting the dataset
GOOG_daily_ret_training <- ts(as.numeric(GOOG_xts.retDaily[training_dataset_range]), frequency = 252, start=c(2019, 1))
GOOG_daily_ret_test <- ts(as.numeric(GOOG_xts.retDaily[test_dataset_range]), frequency = 252, start=c(2021, 1))
```